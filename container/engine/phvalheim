#!/bin/bash
echo
echo "`date` [NOTICE : phvalheim] Starting PhValheim pre-flight..."
echo "`date` [NOTICE : phvalheim] PhValheim Version: $phvalheimVersion"


# load configs
source /opt/stateless/engine/includes/phvalheim-static.conf
source /opt/stateless/engine/includes/0-functions.sh

# set initial timezone from env var (DB not ready yet)
/opt/stateless/engine/tools/tzSetter.sh

# wait for database
/opt/stateless/engine/includes/1-waitfordatabase.sh

# run database schema update processor
/opt/stateless/engine/tools/dbUpdater.sh

# prep directories and filesystem
/opt/stateless/engine/tools/phvalheimprep.sh

# migrate environment variables to database (one-time, for upgrades from pre-2.31)
setupComplete=$(SQL "SELECT setupComplete FROM settings")
if [ "$setupComplete" = "0" ]; then
	# Check if any env vars are set (indicates upgrade from older version)
	envVarFound=0
	for envVar in steamAPIKey gameDNS basePort defaultSeed phvalheimClientURL backupsToKeep sessionTimeout openaiApiKey geminiApiKey claudeApiKey ollamaUrl TZ; do
		val="${!envVar}"
		if [ ! -z "$val" ]; then
			envVarFound=1
			break
		fi
	done

	if [ $envVarFound = 1 ]; then
		echo "`date` [NOTICE : phvalheim] Migrating environment variables to database settings..."

		# Migrate each env var if it has a value
		[ ! -z "$steamAPIKey" ]       && SQL "UPDATE settings SET steamApiKey='$steamAPIKey'"
		[ ! -z "$gameDNS" ]           && SQL "UPDATE settings SET gameDNS='$gameDNS'"
		[ ! -z "$basePort" ]          && SQL "UPDATE settings SET basePort='$basePort'"
		[ ! -z "$defaultSeed" ]       && SQL "UPDATE settings SET defaultSeed='$defaultSeed'"
		[ ! -z "$phvalheimClientURL" ] && SQL "UPDATE settings SET phvalheimClientURL='$phvalheimClientURL'"
		[ ! -z "$backupsToKeep" ]     && SQL "UPDATE settings SET backupsToKeep='$backupsToKeep'"
		[ ! -z "$sessionTimeout" ]    && SQL "UPDATE settings SET sessionTimeout='$sessionTimeout'"
		[ ! -z "$openaiApiKey" ]      && SQL "UPDATE settings SET openaiApiKey='$openaiApiKey'"
		[ ! -z "$geminiApiKey" ]      && SQL "UPDATE settings SET geminiApiKey='$geminiApiKey'"
		[ ! -z "$claudeApiKey" ]      && SQL "UPDATE settings SET claudeApiKey='$claudeApiKey'"
		[ ! -z "$ollamaUrl" ]         && SQL "UPDATE settings SET ollamaUrl='$ollamaUrl'"
		[ ! -z "$TZ" ]                && SQL "UPDATE settings SET timezone='$TZ'"

		# Mark as migrated (setupComplete=1 triggers one-time migration notice in admin UI)
		SQL "UPDATE settings SET setupComplete=1, migrationNoticeShown=0"
		echo "`date` [NOTICE : phvalheim] Environment variables migrated to database. These env vars are now deprecated and can be removed from your Docker configuration."
	else
		echo "`date` [NOTICE : phvalheim] Fresh install detected. Setup wizard will be available at the admin UI (port 8081)."
	fi
fi

# pull settings from database (DB is now the source of truth)
export basePort=$(SQL "SELECT basePort FROM settings")
export defaultSeed=$(SQL "SELECT defaultSeed FROM settings")
export gameDNS=$(SQL "SELECT gameDNS FROM settings")
export steamAPIKey=$(SQL "SELECT steamApiKey FROM settings")
export phvalheimClientURL=$(SQL "SELECT phvalheimClientURL FROM settings")
export backupsToKeep=$(SQL "SELECT backupsToKeep FROM settings")
export maxLogSize=$(SQL "SELECT maxLogSize FROM settings")
export sessionTimeout=$(SQL "SELECT sessionTimeout FROM settings")
export TZ=$(SQL "SELECT timezone FROM settings")

# apply timezone from database to the running system
if [ -f "/usr/share/zoneinfo/$TZ" ]; then
	echo "$TZ" > /etc/timezone
	ln -sf /usr/share/zoneinfo/$TZ /etc/localtime
else
	echo "`date` [WARN : phvalheim] Invalid timezone '$TZ' in database, falling back to UTC"
	export TZ="Etc/UTC"
	echo "$TZ" > /etc/timezone
	ln -sf /usr/share/zoneinfo/$TZ /etc/localtime
fi

# set environment
/usr/bin/printenv |grep -v "HOME="|grep -v "PWD=" > /etc/environment
cat /etc/bash.bashrc|grep "source /etc/environment" > /dev/null 2>&1
if [ ! $? = 0 ]; then
        echo "source /etc/environment" >> /etc/bash.bashrc
fi

# post pre-flight echos
echo "`date` [NOTICE : phvalheim] basePort: $basePort"
echo "`date` [NOTICE : phvalheim] defaultSeed: $defaultSeed"
echo "`date` [NOTICE : phvalheim] gameDNS: $gameDNS"
echo "`date` [NOTICE : phvalheim] backupsToKeep: $backupsToKeep"
echo "`date` [NOTICE : phvalheim] maxLogSize: $maxLogSize"
echo "`date` [NOTICE : phvalheim] timezone: $TZ"

# start the engine
echo "`date` [NOTICE : phvalheim] PhValheim engine started..."

# autostart routine
autoStart

####### BEGIN: Main loop #######
while [ true ]; do
	sleep 2

	# Re-read environment so admin UI setting changes (timezone, etc.) take effect
	source /etc/environment

	WORLDS=$(SQL "SELECT id FROM worlds;")

	for WORLD in $WORLDS; do
		worldID=$WORLD
		worldMode=$(SQL "SELECT mode FROM worlds WHERE id='$worldID';")
		worldName=$(SQL "SELECT name FROM worlds WHERE id='$worldID';")
		worldPort=$(SQL "SELECT port FROM worlds WHERE id='$worldID';")
		worldSeed=$(SQL "SELECT seed FROM worlds WHERE id='$worldID';")
		worldHost=$(SQL "SELECT external_endpoint FROM worlds WHERE id='$worldID';")
		worldPassword="hammertime";


		if [ "$worldMode" = "stopped" ]; then
			orphanedPIDs=$(ps -ef|grep phvalhe+|grep "/opt/stateful/games/valheim/worlds/$worldName/game/valheim_server.x86_64"|grep -v "sh -c"|grep -v grep|tr -s " " |cut -d " " -f2)
			for orphanedPID in $orphanedPIDs; do
				echo "`date` [WARN: phvalheim] Murdering orphaned PID: $orphanedPID"
				kill -9 $orphanedPID
			done
		fi


		if [ -z "$worldSeed" ]; then
			worldSeed="$defaultSeed"
		fi


		if [ "$worldMode" = "create" ]; then
			echo "`date` [NOTICE : phvalheim] New world '$worldName' detected, creating..."
			SQL "UPDATE worlds SET mode='creating' WHERE name='$worldName'"

			# Assign port if not already assigned (may be NULL if directory was pre-created by clone)
			worldPort=$(SQL "SELECT port FROM worlds WHERE name='$worldName'")
			if [ -z "$worldPort" ] || [ "$worldPort" = "NULL" ]; then
				echo "`date` [NOTICE : phvalheim] Assigning port for '$worldName'..."
				worldPort=$(getNextPort)
				SQL "UPDATE worlds SET port='$worldPort' WHERE name='$worldName'"
			fi

			# Create directory structure if it doesn't exist
			if [ ! -d "$worldsDirectoryRoot/$worldName" ]; then
				echo "`date` [NOTICE : phvalheim] Worlds directory for '$worldName' is missing, creating..."
				worldDirPrep "$worldName"
			else
				echo "`date` [NOTICE : phvalheim] Worlds directory for '$worldName' already exists (from clone), ensuring structure..."
				worldDirPrep "$worldName"
			fi

			echo "`date` [NOTICE : phvalheim] Deploying new world '$worldName'..."
			chown -R phvalheim: $worldsDirectoryRoot/$worldName
			RESULT=$?
			if [ $RESULT = 0 ]; then
				echo "`date` [NOTICE : phvalheim] World '$worldName' successfully created..."

				echo "`date` [NOTICE : phvalheim] Checking for required mods..."

				#generate custom seed config
				createCustomSeedConfig "$worldName" "$worldSeed"

				#create supervisor config file for this world
				createSupervisorWorldConfig "$worldName" "$worldPassword" "$worldPort"

                                #set create and updated timestamp for new deployment
                                SQL "UPDATE worlds SET date_deployed='`date +'%F %T'`' WHERE name='$worldName'"

				#set new world to update state
				SQL "UPDATE worlds SET mode='update' WHERE name='$worldName'"

			else
				echo "`date` [FAIL : phvalheim] ERROR: World '$worldName' failed deployment..."
				SQL "DELETE FROM worlds WHERE name='$worldName'"
				rm -rf /opt/stateful/games/valheim/worlds/$worldName
			fi
		fi

		if [ "$worldMode" = "delete" ]; then
			echo "`date` [WARN : phvalheim] Delete command received for world '$worldName':"
			worldNameLength=$(echo "$worldName"|wc -c)
			if [ $worldNameLength -gt 1 ]; then
				echo "`date` [WARN : phvalheim] Deleting world '$worldName'..."
	                        orphanedPIDs=$(ps -ef|grep phvalhe+|grep "/opt/stateful/games/valheim/worlds/$worldName/game/valheim_server.x86_64"|grep -v "sh -c"|grep -v grep|tr -s " " |cut -d " " -f2)
	                        for orphanedPID in $orphanedPIDs; do
	                                echo "`date` [WARN : phvalheim] Murdering orphaned PID: $orphanedPID"
	                                kill -9 $orphanedPID
	                        done
				rm -rf $worldsDirectoryRoot/$worldName
			        
				#delete supervisor config file for this world
                                deleteSupervisorWorldConfig "$worldName"

				SQL "DELETE FROM worlds WHERE name='$worldName'"
			fi
		fi

                if [ "$worldMode" = "stop" ]; then
			echo "`date` [NOTICE : phvalheim] Stop command received for world '$worldName':"
			/usr/bin/supervisorctl status valheimworld_$worldName > /dev/null 2>&1
                        worldPID_status=$?
			if [ $? = 0 ]; then
				SQL "UPDATE worlds SET mode='stopping' WHERE name='$worldName'"
				echo "`date` [NOTICE : phvalheim] Stopping world '$worldName'..."
				/usr/bin/supervisorctl stop valheimworld_$worldName > /dev/null 2>&1
			else
				echo "`date` [WARN : phvalheim] World '$worldName' doesn't appear to be running..."
				SQL "UPDATE worlds SET mode='stopped' WHERE name='$worldName'"
			fi

			#Give it time to stop (we're sending a graceful shutdown, SIGINT)
			killLoop=0
			while [ $killLoop -le 5 ]; do
				sleep 10 
				let killLoop=killLoop+1
				ps -p $worldPID > /dev/null 2>&1
	                        if [ ! $? = 0 ]; then
	                                echo "`date` [NOTICE : phvalheim] World '$worldName' successfully stopped."
					SQL "UPDATE worlds SET mode='stopped' WHERE name='$worldName'"
					break
				else
					echo "`date` [WARN : phvalheim] World '$worldName' did not stop in the allowed time of 10 seconds. The world may still stop soon. You should probably check this..."
	                        fi
			done
		
		fi

		if [ "$worldMode" = "start" ]; then
			echo "`date` [NOTICE : phvalheim] Start command recieved for world '$worldName':"

			/usr/bin/supervisorctl status valheimworld_$worldName > /dev/null 2>&1
			worldPID_status=$?
			if [ $worldPID_status = 0 ]; then
				echo "`date` [WARN : phvalheim] World '$worldName' is already running..."
				SQL "UPDATE worlds SET mode='running' WHERE name='$worldName'"
			else
				SQL "UPDATE worlds SET mode='starting' WHERE name='$worldName'"
				/usr/bin/supervisorctl start valheimworld_$worldName > /dev/null 2>&1
				if [ $? != 0 ]; then
					echo "`date` [ERROR : phvalheim] ERROR: Could not start world '$worldName', exiting..."
					exit 1
				fi

				
				/usr/bin/supervisorctl status valheimworld_$worldName > /dev/null 2>&1
				worldPID_status=$?		
				while [ $worldPID_status != 0 ]; do
					echo "`date` [NOTICE : phvalheim] Waiting for world '$worldName' to start..."
					sleep 2
					/usr/bin/supervisorctl status valheimworld_$worldName > /dev/null 2>&1
	                                worldPID_status=$?
				done
	
				
				/usr/bin/supervisorctl status valheimworld_$worldName > /dev/null 2>&1
                                worldPID_status=$?	
				if [ $worldPID_status = 0 ]; then
					echo "`date` [NOTICE : phvalheim] World '$worldName' has started!"
					SQL "UPDATE worlds SET mode='running' WHERE name='$worldName'"
				else
					echo "`date` World '$worldName' wasn't able to start, exiting..."
					SQL "UPDATE worlds SET mode='broken' WHERE name='$worldName'"
				fi
			fi
		fi

		if [ "$worldMode" = "update" ]; then
			echo "`date` [NOTICE : phvalheim] Update command recieved for world '$worldName':"
	                worldPID=$(SQL "SELECT pid FROM worlds WHERE id='$worldID';")
                        ps -p $worldPID > /dev/null 2>&1
                        if [ $? = 0 ]; then
                                echo "`date` [WARN : phvalheim] World '$worldName' is running. Stop the world before updating..."
			else
				echo "`date` [NOTICE : phvalheim] Updating world '$worldName'..."
				SQL "UPDATE worlds SET mode='updating' WHERE name='$worldName'"

				#Update Valheim
				InstallAndUpdateValheim "$worldName"
				if [ $? -ne 0 ]; then
					echo "`date` [ERROR : phvalheim] Valheim installation failed for '$worldName', aborting update..."
					SQL "UPDATE worlds SET mode='stopped', status='failed' WHERE name='$worldName'"
					continue
				fi

				#Update BepInEx
				InstallAndUpdateBepInEx "$worldName"

				#Delete mods+configs, before downloading, installing and packaging. This is needed when a mod is removed.
				purgeWorldModsConfigsPatchers "$worldName"

                                #add required mods to final list
                                mergeRequiredTsMods "$worldName"

				#Install mods
				downloadAndInstallTsModsForWorld "$worldName"

                                #generate mod viwer list
                                generateModViewerJson "$worldName"

				#Generate quick connect config
				createQuickConnectConfig "$worldName" "$worldHost" "$worldPort" "$worldPassword"

                                #Install system plugins (health monitor, etc)
                                installSystemPlugins "$worldName"

                                #Install custom mods and config
                                installCustomModsConfigsPatchers "$worldName"

				#Packge client
                                packageClient "$worldName"

				#Copy custom_config_secure files to. These files will not end up on the client side
                                InstallCustomConfigSecureFiles "$worldName"

				#Update the database to reflect new client pacakge version via MD5
                                worldMD5=$(getMD5 "/opt/stateful/games/valheim/worlds/$worldName/$worldName.zip")
                                setMD5 "$worldName" "$worldMD5"

				#set last updated timestamp
				SQL "UPDATE worlds SET date_updated='`date +'%F %T'`' WHERE name='$worldName'"

				#finally, set the world to stopped state
				SQL "UPDATE worlds SET mode='stopped' WHERE name='$worldName'"

								

			fi
		fi



	done

done
####### END: Main loop #######
